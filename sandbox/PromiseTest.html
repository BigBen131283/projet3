<!--
        Mar 09 2022     Initial
        Mar 10 2022     Add functions and more tests on Promise, async, await...
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromiseTest</title>
</head>
<body>
    <h1>This page is used to test asynchronous calls</h1>
    <h2 id="h2id"></h2>
    <script type="module">

        import { getDateTime, getDate, getTime, getHoursMinutes, getShortTime  } from './utilities/datetime.js';

        document.getElementById("h2id").textContent = getDateTime();

        let urlbase = "https://api.jcdecaux.com/vls/v1/stations";
        let apikey = "0b872e25a940eeebc3e9a35346780b1074916a8f";
        let resultat = {};

        let url1 = urlbase + "?contract=" + "LYON" + "&apiKey=" + apikey; 
        let url2 = urlbase + "?contract=TOULOUSE&apiKey=" + apikey; 
        let req1 = fetch(url1)
            .then( response => {
                return response.json();
            })
            .then( json =>  { 
                return(json);
            })
            .catch (error => {
                console.log("Y a un putain de bug !!!!!");
            })
        let req2 = fetch(url2)
            .then( response => {
                return response.json();
            })
            .then( json =>  { 
                return(json);
            })
            .catch (error => {
                console.log("Y a un putain de bug !!!!!");
            })
        let req3 = new Promise((resolve, reject) => {
                        setTimeout(() => {
                            resolve('Delay OK');
                        }, 1000);
                    });

        Promise.all([req1, req2, req3])
            .then( (results) => {
                log("Stations dans LYON: " + results[0].length);
                log("Stations dans TOULOUSE: " + results[1].length);
                log('req3 has been fullfilled after 1 sec');
            })
            .catch( error => {
                log(error)
            })
        // ---------------------------------------------------------
        //  Logger 
        // ---------------------------------------------------------
        function log(message) {
            console.log(getTime() + ': ' + message);
        }
        // ---------------------------------------------------------
        //  Sleep on demand 
        // ---------------------------------------------------------
        function sleep(ms, initmess) { 
            log(initmess);
            return new Promise(resolve => setTimeout(resolve, ms)); 
        }
        // ---------------------------------------------------------
        // Function to test Promise 
        // ---------------------------------------------------------
        function testme(delay, message) {
            return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            resolve('***** ' + message + ' after ' + delay + ' ms');
                        }, delay);
                    });
        }
        // ---------------------------------------------------------
        // Function to test Promise 
        // ---------------------------------------------------------
        function callurl(url) {
            return new Promise((resolve, reject) => { 
                fetch(url)
                    .then( response => {
                        return response.json();
                    })
                    .then( json =>  { 
                        resolve(json);
                    })
                    .catch (error => {
                        log(error);
                        reject(error);
                    })
            })
        }
        // ---------------------------------------------------------
        // Now call testme to check
        // ---------------------------------------------------------
        ( async () => {
            await testme(5000, '-----------------> 1st job').then( (resp) => {
                log(resp);
            })
            await testme(1000, '-----------------> Job is done').then( (resp) => {
                log(resp);
            })
        })()
        sleep(5000, '[][][][][][][] Start 1st sleeping').then( () => log(`[][][][][][][] End 1st sleep`));
        sleep(3000, '[][][][][][][] Start 2nd sleeping').then( () => log('[][][][][][][] End 2nd sleep'));
        // ---------------------------------------------------------
        // Another cool way to do this
        // ---------------------------------------------------------
        const macro = async ( message, f) => {
            log(message);
            await f.then( (resp) => {
                log(resp);
            });
        };
        macro("%%%%%%%%%%%%%%%%% Macro call 12sec", testme(12000, '%%%%%%%%%%%%%% Macro end'));
        macro("%%%%%%%%%%%%%%%%% Macro call 14sec", testme(14000, '%%%%%%%%%%%%%% Macro end'));
        // ---------------------------------------------------------
        // Finally test a macro with a fetch request
        // Here we pass a message, an input function returning a Promise
        // and an output function processing the data
        // ---------------------------------------------------------
        const urlmacro = async ( message, fIn, fOut) => {
            log(message);
            await fIn.then( (resp) => {
                fOut(resp);
            });
        };
        let citystations =  [];
        function process(jsondata) {
            for(let index = 0; index < 3; ++index) {
                log(jsondata[index].name)    
            }
            citystations = jsondata;
            log('TOULOUSE exploits ' + citystations.length + ' stations');
        }
        urlmacro('Calling url with macro', callurl(url2), process);
        // Can also write this like that
        urlmacro('Calling url with macro', callurl(url1), (data) => {
            for(let index = 0; index < 3; ++index) {
                log(data[index].name)
            }
            log('LYON exploits ' + data.length + ' stations');
        });
    </script>
</body>
</html>